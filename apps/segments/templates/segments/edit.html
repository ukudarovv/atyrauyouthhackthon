{% extends 'base.html' %}

{% block title %}{{ is_editing|yesno:"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ,–°–æ–∑–¥–∞–Ω–∏–µ" }} —Å–µ–≥–º–µ–Ω—Ç–∞{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-6">
        <div class="flex items-center space-x-2 mb-2">
            <a href="{% url 'segments:list' %}" class="text-blue-600 hover:text-blue-800">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–µ–≥–º–µ–Ω—Ç–∞–º</a>
        </div>
        <h1 class="text-2xl font-semibold">
            {{ is_editing|yesno:"‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ,‚ûï –°–æ–∑–¥–∞–Ω–∏–µ" }} —Å–µ–≥–º–µ–Ω—Ç–∞
        </h1>
        {% if segment.kind == 'system' %}
            <p class="text-yellow-600">‚ö†Ô∏è –°–∏—Å—Ç–µ–º–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
        {% endif %}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- –§–æ—Ä–º–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ -->
        <div class="lg:col-span-2">
            <form method="post" class="bg-white rounded-lg shadow p-6">
                {% csrf_token %}
                
                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
                            –ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞ *
                        </label>
                        <input 
                            type="text" 
                            name="name" 
                            id="name"
                            value="{{ segment.name }}"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            {% if not can_edit %}readonly{% endif %}
                            required
                        />
                    </div>
                    
                    <div>
                        <label for="slug" class="block text-sm font-medium text-gray-700 mb-1">
                            Slug (URL-–∏–º—è)
                        </label>
                        <input 
                            type="text" 
                            name="slug" 
                            id="slug"
                            value="{{ segment.slug }}"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            {% if not can_edit %}readonly{% endif %}
                            placeholder="auto-generate"
                        />
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="color" class="block text-sm font-medium text-gray-700 mb-1">
                            –¶–≤–µ—Ç —Å–µ–≥–º–µ–Ω—Ç–∞
                        </label>
                        <input 
                            type="color" 
                            name="color" 
                            id="color"
                            value="{{ segment.color }}"
                            class="w-full h-10 border border-gray-300 rounded-md"
                            {% if not can_edit %}disabled{% endif %}
                        />
                    </div>
                    
                    <div class="flex items-end">
                        <label class="inline-flex items-center">
                            <input 
                                type="checkbox" 
                                name="enabled" 
                                {% if segment.enabled %}checked{% endif %}
                                class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                {% if not can_edit %}disabled{% endif %}
                            />
                            <span class="ml-2 text-sm text-gray-700">–°–µ–≥–º–µ–Ω—Ç –∞–∫—Ç–∏–≤–µ–Ω</span>
                        </label>
                    </div>
                </div>

                <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                <div class="mb-6">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
                        –û–ø–∏—Å–∞–Ω–∏–µ
                    </label>
                    <textarea 
                        name="description" 
                        id="description"
                        rows="2"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        {% if not can_edit %}readonly{% endif %}
                        placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞..."
                    >{{ segment.description }}</textarea>
                </div>

                <!-- –ü—Ä–∞–≤–∏–ª–∞ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ -->
                <div class="mb-6">
                    <label for="definition" class="block text-sm font-medium text-gray-700 mb-1">
                        –ü—Ä–∞–≤–∏–ª–∞ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ (JSON) *
                    </label>
                    <textarea 
                        name="definition" 
                        id="definition"
                        rows="12"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                        {% if not can_edit %}readonly{% endif %}
                        required
                    >{{ definition_text }}</textarea>
                    
                    <div class="mt-2 text-xs text-gray-600">
                        <details>
                            <summary class="cursor-pointer text-blue-600 hover:text-blue-800">–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª</summary>
                            <div class="mt-2 space-y-2 bg-gray-50 p-3 rounded">
                                <div><strong>VIP –∫–ª–∏–µ–Ω—Ç—ã:</strong></div>
                                <pre class="text-xs bg-white p-2 rounded overflow-x-auto">{"logic": "all", "conds": [{"field": "r_score", "op": ">=", "value": 4}, {"field": "f_score", "op": ">=", "value": 4}]}</pre>
                                
                                <div><strong>–†–∏—Å–∫ –æ—Ç—Ç–æ–∫–∞:</strong></div>
                                <pre class="text-xs bg-white p-2 rounded overflow-x-auto">{"logic": "all", "conds": [{"field": "recency_days", "op": ">=", "value": 45}, {"field": "redeems_count", "op": ">=", "value": 1}]}</pre>
                                
                                <div><strong>–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã:</strong></div>
                                <pre class="text-xs bg-white p-2 rounded overflow-x-auto">{"logic": "all", "conds": [{"field": "recency_days", "op": "<=", "value": 14}, {"field": "redeems_count", "op": ">=", "value": 2}]}</pre>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ -->
                {% if can_edit %}
                    <div class="flex space-x-3">
                        <button 
                            type="submit"
                            class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            üíæ {{ is_editing|yesno:"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è,–°–æ–∑–¥–∞—Ç—å —Å–µ–≥–º–µ–Ω—Ç" }}
                        </button>
                        
                        {% if is_editing %}
                            <a 
                                href="{% url 'segments:rebuild' segment.id %}"
                                class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                            >
                                üîÑ –ü–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å
                            </a>
                        {% endif %}
                        
                        <a 
                            href="{% url 'segments:list' %}"
                            class="px-6 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50"
                        >
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </a>
                    </div>
                {% else %}
                    <div class="bg-yellow-50 border border-yellow-200 rounded p-4">
                        <p class="text-yellow-800">
                            üîí –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã –Ω–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å. –û–Ω–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                        </p>
                        <div class="mt-3">
                            <a 
                                href="{% url 'segments:list' %}"
                                class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
                            >
                                ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
                            </a>
                        </div>
                    </div>
                {% endif %}
            </form>
        </div>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏–Ω—Å–∞–π—Ç–∞–º–∏ -->
        <div class="space-y-6">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ -->
            {% if insights %}
                <div class="bg-white rounded-lg shadow p-4">
                    <h3 class="font-medium text-gray-900 mb-3">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–∞</h3>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">–†–∞–∑–º–µ—Ä:</span>
                            <span class="text-sm font-medium">{{ insights.size }} –∫–ª–∏–µ–Ω—Ç–æ–≤</span>
                        </div>
                        
                        <div class="border-t pt-3">
                            <div class="text-sm text-gray-600 mb-2">–°—Ä–µ–¥–Ω–∏–µ RFM –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:</div>
                            <div class="grid grid-cols-3 gap-2 text-center">
                                <div class="bg-green-50 p-2 rounded">
                                    <div class="text-lg font-semibold text-green-600">{{ insights.avg_rfm.r }}</div>
                                    <div class="text-xs text-green-800">Recency</div>
                                </div>
                                <div class="bg-blue-50 p-2 rounded">
                                    <div class="text-lg font-semibold text-blue-600">{{ insights.avg_rfm.f }}</div>
                                    <div class="text-xs text-blue-800">Frequency</div>
                                </div>
                                <div class="bg-purple-50 p-2 rounded">
                                    <div class="text-lg font-semibold text-purple-600">{{ insights.avg_rfm.m }}</div>
                                    <div class="text-xs text-purple-800">Monetary</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t pt-3 space-y-2">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">–°—Ä–µ–¥–Ω—è—è –¥–∞–≤–Ω–æ—Å—Ç—å:</span>
                                <span class="text-sm font-medium">{{ insights.avg_recency|floatformat:0 }} –¥–Ω.</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">–û–±—â–∏–π LTV:</span>
                                <span class="text-sm font-medium">{{ insights.total_ltv|floatformat:0 }} ‚Ç∏</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">–°—Ä–µ–¥–Ω–∏–π LTV:</span>
                                <span class="text-sm font-medium">{{ insights.avg_ltv|floatformat:0 }} ‚Ç∏</span>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Next Best Promo —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
            {% if insights.recommendations %}
                <div class="bg-blue-50 rounded-lg border border-blue-200 p-4">
                    <h3 class="font-medium text-blue-900 mb-3">üí° Next Best Promo</h3>
                    
                    <div class="space-y-3 text-sm">
                        <div>
                            <span class="text-blue-700 font-medium">–°–∫–∏–¥–∫–∞:</span>
                            <span class="text-blue-900">{{ insights.recommendations.discount }}</span>
                        </div>
                        
                        <div>
                            <span class="text-blue-700 font-medium">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</span>
                            <span class="text-blue-900">{{ insights.recommendations.duration_days }} –¥–Ω–µ–π</span>
                        </div>
                        
                        <div>
                            <span class="text-blue-700 font-medium">CTA:</span>
                            <span class="text-blue-900">"{{ insights.recommendations.cta }}"</span>
                        </div>
                        
                        {% if insights.recommendations.recommended_channels %}
                            <div>
                                <span class="text-blue-700 font-medium">–ö–∞–Ω–∞–ª—ã:</span>
                                <span class="text-blue-900">{{ insights.recommendations.recommended_channels|join:", " }}</span>
                            </div>
                        {% endif %}
                        
                        {% if insights.recommendations.timing %}
                            <div>
                                <span class="text-blue-700 font-medium">–í—Ä–µ–º—è:</span>
                                <span class="text-blue-900">{{ insights.recommendations.timing }}</span>
                            </div>
                        {% endif %}
                        
                        {% if insights.recommendations.notes %}
                            <div class="border-t border-blue-200 pt-3">
                                <span class="text-blue-700 font-medium">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</span>
                                <p class="text-blue-800 mt-1">{{ insights.recommendations.notes }}</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <!-- –°–ø—Ä–∞–≤–∫–∞ –ø–æ –ø–æ–ª—è–º -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-medium text-gray-900 mb-3">üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è</h3>
                
                <div class="space-y-2 text-xs">
                    <div><code class="bg-white px-1 rounded">recency_days</code> - –¥–Ω–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è</div>
                    <div><code class="bg-white px-1 rounded">issues_count</code> - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–¥–∞–Ω–Ω—ã—Ö –∫—É–ø–æ–Ω–æ–≤</div>
                    <div><code class="bg-white px-1 rounded">redeems_count</code> - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≥–∞—à–µ–Ω–∏–π</div>
                    <div><code class="bg-white px-1 rounded">r_score</code> - Recency —Å–∫–æ—Ä (1-5)</div>
                    <div><code class="bg-white px-1 rounded">f_score</code> - Frequency —Å–∫–æ—Ä (1-5)</div>
                    <div><code class="bg-white px-1 rounded">m_score</code> - Monetary —Å–∫–æ—Ä (1-5)</div>
                    <div><code class="bg-white px-1 rounded">redeem_amount_total</code> - –æ–±—â–∞—è —Å—É–º–º–∞ –ø–æ–≥–∞—à–µ–Ω–∏–π</div>
                    <div><code class="bg-white px-1 rounded">first_seen_days_ago</code> - –¥–Ω–µ–π —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
                    <div><code class="bg-white px-1 rounded">last_issue_days_ago</code> - –¥–Ω–µ–π —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤—ã–¥–∞—á–∏</div>
                </div>
                
                <div class="mt-3 pt-3 border-t border-gray-200">
                    <div class="text-gray-700 font-medium mb-2">–û–ø–µ—Ä–∞—Ç–æ—Ä—ã:</div>
                    <div class="space-y-1 text-xs">
                        <div><code class="bg-white px-1 rounded"><=</code>, <code class="bg-white px-1 rounded">>=</code>, <code class="bg-white px-1 rounded">=</code></div>
                        <div><code class="bg-white px-1 rounded"><</code>, <code class="bg-white px-1 rounded">></code></div>
                        <div><code class="bg-white px-1 rounded">between</code> - [–º–∏–Ω, –º–∞–∫—Å]</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
