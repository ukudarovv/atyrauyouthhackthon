{% extends 'base.html' %}

{% block title %}–°–µ–≥–º–µ–Ω—Ç—ã –∫–ª–∏–µ–Ω—Ç–æ–≤{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-semibold">üéØ –°–µ–≥–º–µ–Ω—Ç—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</h1>
            <p class="text-gray-600">RFM –∞–Ω–∞–ª–∏–∑ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</p>
        </div>
        <a href="{% url 'segments:new' %}" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
            ‚ûï –°–æ–∑–¥–∞—Ç—å —Å–µ–≥–º–µ–Ω—Ç
        </a>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <form method="get" class="flex flex-wrap gap-4 items-end">
            <div>
                <label for="kind" class="block text-sm font-medium text-gray-700 mb-1">
                    –¢–∏–ø —Å–µ–≥–º–µ–Ω—Ç–∞
                </label>
                <select name="kind" id="kind" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">–í—Å–µ</option>
                    <option value="system" {% if current_kind == 'system' %}selected{% endif %}>ü§ñ –°–∏—Å—Ç–µ–º–Ω—ã–µ</option>
                    <option value="custom" {% if current_kind == 'custom' %}selected{% endif %}>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ</option>
                </select>
            </div>
            
            <div>
                <label for="enabled" class="block text-sm font-medium text-gray-700 mb-1">
                    –°—Ç–∞—Ç—É—Å
                </label>
                <select name="enabled" id="enabled" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">–í—Å–µ</option>
                    <option value="1" {% if current_enabled == '1' %}selected{% endif %}>‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="0" {% if current_enabled == '0' %}selected{% endif %}>‚ùå –û—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ</option>
                </select>
            </div>
            
            <div class="flex space-x-2">
                <button type="submit" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                    üîç –§–∏–ª—å—Ç—Ä
                </button>
                <a href="{% url 'segments:list' %}" class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50">
                    ‚úñÔ∏è –°–±—Ä–æ—Å–∏—Ç—å
                </a>
            </div>
        </form>
    </div>

    <!-- –°–µ–≥–º–µ–Ω—Ç—ã -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        {% for item in segments_data %}
            {% with segment=item.segment insights=item.insights %}
                <div class="bg-white rounded-lg shadow hover:shadow-md transition-shadow">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ–≥–º–µ–Ω—Ç–∞ -->
                    <div class="p-4 border-b border-gray-200">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <div class="w-3 h-3 rounded-full" style="background-color: {{ segment.color }}"></div>
                                    <h3 class="font-medium text-gray-900">{{ segment.name }}</h3>
                                    {% if not segment.enabled %}
                                        <span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">–û—Ç–∫–ª—é—á–µ–Ω</span>
                                    {% endif %}
                                </div>
                                
                                <div class="flex items-center space-x-3 text-sm text-gray-600">
                                    <span>{{ segment.kind_display }}</span>
                                    <span class="text-2xl font-bold text-blue-600">{{ insights.size|default:0 }}</span>
                                    <span>–∫–ª–∏–µ–Ω—Ç–æ–≤</span>
                                </div>
                            </div>
                            
                            {% if segment.is_stale %}
                                <span class="px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded" title="–¢—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è">
                                    ‚ö†Ô∏è –£—Å—Ç–∞—Ä–µ–ª
                                </span>
                            {% endif %}
                        </div>
                        
                        {% if segment.description %}
                            <p class="text-sm text-gray-600 mt-2">{{ segment.description }}</p>
                        {% endif %}
                    </div>

                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                    {% if insights.size > 0 %}
                        <div class="p-4 border-b border-gray-200">
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <div class="text-lg font-semibold text-green-600">{{ insights.avg_rfm.r }}</div>
                                    <div class="text-xs text-gray-500">Recency</div>
                                </div>
                                <div>
                                    <div class="text-lg font-semibold text-blue-600">{{ insights.avg_rfm.f }}</div>
                                    <div class="text-xs text-gray-500">Frequency</div>
                                </div>
                                <div>
                                    <div class="text-lg font-semibold text-purple-600">{{ insights.avg_rfm.m }}</div>
                                    <div class="text-xs text-gray-500">Monetary</div>
                                </div>
                            </div>
                            
                            <div class="mt-3 text-center">
                                <div class="text-sm text-gray-600">
                                    –°—Ä–µ–¥–Ω—è—è –¥–∞–≤–Ω–æ—Å—Ç—å: <strong>{{ insights.avg_recency|floatformat:0 }} –¥–Ω.</strong>
                                </div>
                                <div class="text-sm text-gray-600">
                                    –û–±—â–∏–π LTV: <strong>{{ insights.total_ltv|floatformat:0 }} ‚Ç∏</strong>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- –ü—Ä–µ–≤—å—é —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
                    {% if segment.preview %}
                        <div class="p-3 bg-gray-50 border-b border-gray-200">
                            <div class="text-xs text-gray-500 mb-1">–ü—Ä–µ–≤—å—é —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</div>
                            <div class="flex flex-wrap gap-1">
                                {% for phone in segment.preview %}
                                    <span class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded">{{ phone }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ NBP -->
                    {% if insights.recommendations %}
                        <div class="p-3 bg-blue-50 border-b border-gray-200">
                            <div class="text-xs font-medium text-blue-800 mb-1">üí° Next Best Promo:</div>
                            <div class="text-xs text-blue-700">
                                <strong>{{ insights.recommendations.discount }}</strong> –Ω–∞ {{ insights.recommendations.duration_days }} –¥–Ω.
                            </div>
                            <div class="text-xs text-blue-600 mt-1">
                                "{{ insights.recommendations.cta }}"
                            </div>
                        </div>
                    {% endif %}

                    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                    <div class="p-4">
                        <div class="flex justify-between items-center">
                            <div class="text-xs text-gray-500">
                                {% if segment.last_built_at %}
                                    –û–±–Ω–æ–≤–ª–µ–Ω: {{ segment.last_built_at|date:"d.m H:i" }}
                                {% else %}
                                    –ù–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω
                                {% endif %}
                            </div>
                            
                            <div class="flex space-x-2">
                                <a href="{% url 'segments:preview' segment.id %}" 
                                   class="text-sm text-blue-600 hover:text-blue-800 hover:underline"
                                   onclick="previewSegment({{ segment.id }}); return false;">
                                    üëÅÔ∏è –ü—Ä–µ–≤—å—é
                                </a>
                                
                                <a href="{% url 'segments:rebuild' segment.id %}" 
                                   class="text-sm text-green-600 hover:text-green-800 hover:underline">
                                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                                </a>
                                
                                {% if segment.kind != 'system' %}
                                    <a href="{% url 'segments:edit' segment.id %}" 
                                       class="text-sm text-gray-600 hover:text-gray-800 hover:underline">
                                        ‚úèÔ∏è –ü—Ä–∞–≤–∏—Ç—å
                                    </a>
                                {% else %}
                                    <a href="{% url 'segments:edit' segment.id %}" 
                                       class="text-sm text-gray-400 hover:text-gray-600 hover:underline">
                                        üëÅÔ∏è –°–º–æ—Ç—Ä–µ—Ç—å
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endwith %}
        {% empty %}
            <div class="col-span-full">
                <div class="bg-white rounded-lg shadow p-8 text-center">
                    <div class="text-4xl mb-4">üéØ</div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">–°–µ–≥–º–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                    <p class="text-gray-600 mb-4">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
                    <a href="{% url 'segments:new' %}" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        ‚ûï –°–æ–∑–¥–∞—Ç—å —Å–µ–≥–º–µ–Ω—Ç
                    </a>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if page_obj.has_other_pages %}
        <div class="mt-6 flex justify-center">
            <nav class="flex space-x-2">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                       class="px-3 py-2 text-sm bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-50">
                        ‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                    </a>
                {% endif %}
                
                <span class="px-3 py-2 text-sm bg-blue-50 border border-blue-200 text-blue-700 rounded">
                    {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}
                </span>
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                       class="px-3 py-2 text-sm bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-50">
                        –°–ª–µ–¥—É—é—â–∞—è ‚Üí
                    </a>
                {% endif %}
            </nav>
        </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–≤—å—é -->
<div id="previewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-96 overflow-hidden">
            <div class="p-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-medium">–ü—Ä–µ–≤—å—é —Å–µ–≥–º–µ–Ω—Ç–∞</h3>
                    <button onclick="closePreview()" class="text-gray-400 hover:text-gray-600">‚úñÔ∏è</button>
                </div>
            </div>
            <div id="previewContent" class="p-4 overflow-y-auto max-h-80">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ AJAX -->
            </div>
        </div>
    </div>
</div>

<script>
function previewSegment(segmentId) {
    document.getElementById('previewModal').classList.remove('hidden');
    document.getElementById('previewContent').innerHTML = '<div class="text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    fetch(`/app/segments/${segmentId}/preview/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let html = `<div class="mb-4"><strong>–ù–∞–π–¥–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–≤: ${data.count}</strong></div>`;
                
                if (data.customers.length > 0) {
                    html += '<div class="space-y-2">';
                    data.customers.forEach(customer => {
                        html += `
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <span class="font-mono">${customer.phone_masked}</span>
                                <div class="text-sm text-gray-600">
                                    R${customer.r_score}F${customer.f_score}M${customer.m_score} | 
                                    ${customer.redeems_count} –ø–æ–≥–∞—à. | 
                                    ${customer.recency_days} –¥–Ω.
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += '<div class="text-gray-500">–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                }
                
                document.getElementById('previewContent').innerHTML = html;
            } else {
                document.getElementById('previewContent').innerHTML = `<div class="text-red-600">–û—à–∏–±–∫–∞: ${data.error}</div>`;
            }
        })
        .catch(error => {
            document.getElementById('previewContent').innerHTML = `<div class="text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error}</div>`;
        });
}

function closePreview() {
    document.getElementById('previewModal').classList.add('hidden');
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
document.getElementById('previewModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePreview();
    }
});
</script>
{% endblock %}
