{% extends 'base.html' %}

{% block title %}–ö–∞–º–ø–∞–Ω–∏–∏{% endblock %}

{% block content %}
{% if not current_business %}
<div class="text-center py-12">
    <div class="text-6xl mb-4">üéØ</div>
    <h3 class="text-lg font-medium text-gray-900 mb-2">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –±–∏–∑–Ω–µ—Å</h3>
    <p class="text-gray-500 mb-6">–ß—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –∫–∞–º–ø–∞–Ω–∏—è–º–∏, –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –±–∏–∑–Ω–µ—Å</p>
    <a href="{% url 'businesses:list' %}" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
        –ü–µ—Ä–µ–π—Ç–∏ –∫ –±–∏–∑–Ω–µ—Å–∞–º
    </a>
</div>
{% else %}
<div class="flex justify-between items-center mb-6">
    <div>
        <h1 class="text-2xl font-semibold">–ö–∞–º–ø–∞–Ω–∏–∏</h1>
        <p class="text-gray-600">{{ current_business.name }}</p>
    </div>
    <a href="{% url 'campaigns:create' %}" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
        –°–æ–∑–¥–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
    </a>
</div>

<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for c in campaigns %}
    <div class="bg-white p-6 rounded-lg shadow border">
        <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
                <h3 class="text-lg font-semibold mb-1">{{ c.name }}</h3>
                <p class="text-sm text-gray-600 mb-2">{{ c.description|truncatechars:100 }}</p>
                <div class="text-sm text-gray-500">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                        {% if c.type == 'coupon' %}bg-green-100 text-green-800
                        {% elif c.type == 'referral' %}bg-blue-100 text-blue-800
                        {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                        {{ c.get_type_display }}
                    </span>
                </div>
            </div>
            <div class="flex items-center">
                {% if c.is_running_now %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        –ê–∫—Ç–∏–≤–Ω–∞
                    </span>
                {% else %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        –ù–µ–∞–∫—Ç–∏–≤–Ω–∞
                    </span>
                {% endif %}
            </div>
        </div>
        
        <div class="text-sm text-gray-600 mb-4">
            <p><strong>URL:</strong> <a href="{{ c.get_public_url }}" target="_blank" class="text-blue-600 hover:underline">{{ c.get_public_url }}</a></p>
            {% if c.location %}
                <p><strong>–õ–æ–∫–∞—Ü–∏—è:</strong> {{ c.location.name }}</p>
            {% endif %}
            {% if c.starts_at %}
                <p><strong>–ù–∞—á–∞–ª–æ:</strong> {{ c.starts_at|date:"d.m.Y H:i" }}</p>
            {% endif %}
            {% if c.ends_at %}
                <p><strong>–ö–æ–Ω–µ—Ü:</strong> {{ c.ends_at|date:"d.m.Y H:i" }}</p>
            {% endif %}
        </div>
        
        <div class="text-sm text-gray-500 mb-4">
            <p>–°–æ–±—ã—Ç–∏—è: {{ c.events.count }}</p>
            <p>–°–æ–∑–¥–∞–Ω–∞: {{ c.created_at|date:"d.m.Y" }}</p>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="space-y-2">
            <!-- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ -->
            <div class="grid grid-cols-2 gap-2 text-sm">
                <a href="{% url 'campaigns:edit' c.id %}" class="text-center px-3 py-2 border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                    ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </a>
                <a href="{% url 'campaigns:landing_edit' c.id %}" class="text-center px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                    üé® –õ–µ–Ω–¥–∏–Ω–≥
                </a>
            </div>
            
            <!-- –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞: AI –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä -->
            <div class="grid grid-cols-2 gap-2 text-sm">
                <button onclick="startAICopywriting({{ c.id }})" class="px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors">
                    ü§ñ AI-–∫–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥
                </button>
                <a href="{{ c.get_public_url }}" target="_blank" class="text-center px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                    üëÅÔ∏è –û—Ç–∫—Ä—ã—Ç—å
                </a>
            </div>
            
            <!-- –¢—Ä–µ—Ç—å—è —Å—Ç—Ä–æ–∫–∞: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
            <div class="grid grid-cols-2 gap-2 text-xs">
                <a href="{% url 'coupons:export_csv' %}?campaign={{ c.id }}" class="text-center px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors">
                    üìä –≠–∫—Å–ø–æ—Ä—Ç
                </a>
                <a href="{% url 'coupons:landing_qr' c.slug %}" target="_blank" class="text-center px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors">
                    üì± QR-–∫–æ–¥
                </a>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-span-full">
        <div class="text-center py-12">
            <div class="text-6xl mb-4">üöÄ</div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞–º–ø–∞–Ω–∏–π</h3>
            <p class="text-gray-500 mb-6">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∫–∞–º–ø–∞–Ω–∏—é –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
            <a href="{% url 'campaigns:create' %}" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –∫–∞–º–ø–∞–Ω–∏—é
            </a>
        </div>
    </div>
    {% endfor %}
</div>

{% if campaigns %}
<div class="mt-8 bg-purple-50 border border-purple-200 rounded-lg p-4">
    <div class="flex">
        <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-purple-800">–ü–æ–¥—Å–∫–∞–∑–∫–∏</h3>
            <div class="mt-2 text-sm text-purple-700">
                <ul class="list-disc list-inside space-y-1">
                    <li>–ö–∞–º–ø–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –∏ –∫–ª–∏–∫–∏</li>
                    <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ UTM-–º–µ—Ç–∫–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</li>
                    <li>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ SEO-—Ç–µ–≥–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}

<!-- AI Copywriting Modal -->
<div id="ai-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold">ü§ñ AI-–∫–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥</h3>
                    <button onclick="closeAIModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto">
                <div id="ai-content" class="p-6">
                    <!-- –§–æ—Ä–º–∞ –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–æ–º–ø—Ç–∞ -->
                    <div id="prompt-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                –ö–∞—Å—Ç–æ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):
                            </label>
                            <textarea 
                                id="custom-prompt" 
                                rows="3" 
                                class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–î–æ–±–∞–≤—å —é–º–æ—Ä –∏ –∏–≥—Ä–∏–≤–æ—Å—Ç—å' –∏–ª–∏ '–°—Ç–∏–ª—å –ø—Ä–µ–º–∏—É–º-—Å–µ–≥–º–µ–Ω—Ç–∞' –∏–ª–∏ '–ò—Å–ø–æ–ª—å–∑—É–π –º–æ–ª–æ–¥–µ–∂–Ω—ã–π —Å–ª–µ–Ω–≥'"></textarea>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button 
                                onclick="generateAI()" 
                                class="flex-1 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                                üöÄ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç—ã
                            </button>
                            <button 
                                onclick="closeAIModal()" 
                                class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                        
                        <div class="text-xs text-gray-500">
                            <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –ø—Ä–æ–º–ø—Ç–æ–≤:</strong><br>
                            ‚Ä¢ "–°–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç—ã –±–æ–ª–µ–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏"<br>
                            ‚Ä¢ "–î–æ–±–∞–≤—å —é–º–æ—Ä –∏ –∏–≥—Ä–∏–≤–æ—Å—Ç—å"<br>
                            ‚Ä¢ "–§–æ–∫—É—Å –Ω–∞ —ç–∫–æ–Ω–æ–º–∏–∏ –∏ –≤—ã–≥–æ–¥–µ"<br>
                            ‚Ä¢ "–°—Ç–∏–ª—å –ø—Ä–µ–º–∏—É–º-—Å–µ–≥–º–µ–Ω—Ç–∞"
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentCampaignId = null;

function startAICopywriting(campaignId) {
    currentCampaignId = campaignId;
    document.getElementById('ai-modal').classList.remove('hidden');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('custom-prompt').value = '';
    showPromptForm();
}

function showPromptForm() {
    const content = document.getElementById('ai-content');
    content.innerHTML = `
        <div id="prompt-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    –ö–∞—Å—Ç–æ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):
                </label>
                <textarea 
                    id="custom-prompt" 
                    rows="3" 
                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–°–æ–∑–¥–∞–π —Ç–µ–∫—Å—Ç—ã –¥–ª—è –º–æ–ª–æ–¥–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –≤ —Å—Ç–∏–ª–µ casual' –∏–ª–∏ '–°–¥–µ–ª–∞–π –∞–∫—Ü–µ–Ω—Ç –Ω–∞ —ç–∫–æ–ª–æ–≥–∏—á–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–∞'"></textarea>
            </div>
            
            <div class="flex space-x-3">
                <button 
                    onclick="generateAI()" 
                    class="flex-1 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                    üöÄ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç—ã
                </button>
                <button 
                    onclick="closeAIModal()" 
                    class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
            
                                        <div class="text-xs text-gray-500 bg-blue-50 p-3 rounded">
                                <strong>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –ø—Ä–æ–º–ø—Ç–æ–≤:</strong><br>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
                                    <div>
                                        <strong>üé≠ –°—Ç–∏–ª—å –∏ —Ç–æ–Ω:</strong><br>
                                        ‚Ä¢ "–î–æ–±–∞–≤—å —é–º–æ—Ä –∏ –∏–≥—Ä–∏–≤–æ—Å—Ç—å"<br>
                                        ‚Ä¢ "–°—Ç–∏–ª—å –ø—Ä–µ–º–∏—É–º-—Å–µ–≥–º–µ–Ω—Ç–∞"<br>
                                        ‚Ä¢ "–ò—Å–ø–æ–ª—å–∑—É–π –º–æ–ª–æ–¥–µ–∂–Ω—ã–π —Å–ª–µ–Ω–≥"<br>
                                        ‚Ä¢ "–ë–æ–ª–µ–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã"
                                    </div>
                                    <div>
                                        <strong>üéØ –§–æ–∫—É—Å:</strong><br>
                                        ‚Ä¢ "–§–æ–∫—É—Å –Ω–∞ —ç–∫–æ–Ω–æ–º–∏–∏ –∏ –≤—ã–≥–æ–¥–µ"<br>
                                        ‚Ä¢ "–ê–∫—Ü–µ–Ω—Ç –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å"<br>
                                        ‚Ä¢ "–≠–∫–æ–ª–æ–≥–∏—á–Ω–æ—Å—Ç—å –∏ –∑–∞–±–æ—Ç–∞ –æ –ø—Ä–∏—Ä–æ–¥–µ"<br>
                                        ‚Ä¢ "–°—Ä–æ—á–Ω–æ—Å—Ç—å –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è"
                                    </div>
                                </div>
                                <div class="mt-2 pt-2 border-t border-blue-200">
                                    <strong>üöÄ –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏:</strong>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        <button onclick="setPrompt('–î–æ–±–∞–≤—å —é–º–æ—Ä –∏ –∏–≥—Ä–∏–≤–æ—Å—Ç—å')" class="px-2 py-1 bg-blue-100 hover:bg-blue-200 rounded text-xs">üòÑ –Æ–º–æ—Ä</button>
                                        <button onclick="setPrompt('–°—Ç–∏–ª—å –ø—Ä–µ–º–∏—É–º-—Å–µ–≥–º–µ–Ω—Ç–∞ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ')" class="px-2 py-1 bg-blue-100 hover:bg-blue-200 rounded text-xs">üíé –ü—Ä–µ–º–∏—É–º</button>
                                        <button onclick="setPrompt('–ò—Å–ø–æ–ª—å–∑—É–π –º–æ–ª–æ–¥–µ–∂–Ω—ã–π —Å–ª–µ–Ω–≥ –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è')" class="px-2 py-1 bg-blue-100 hover:bg-blue-200 rounded text-xs">üî• –°–ª–µ–Ω–≥</button>
                                        <button onclick="setPrompt('–§–æ–∫—É—Å –Ω–∞ —ç–∫–æ–Ω–æ–º–∏–∏ –∏ –≤—ã–≥–æ–¥–µ –¥–ª—è —Å–µ–º–µ–π–Ω–æ–≥–æ –±—é–¥–∂–µ—Ç–∞')" class="px-2 py-1 bg-blue-100 hover:bg-blue-200 rounded text-xs">üí∞ –≠–∫–æ–Ω–æ–º–∏—è</button>
                                    </div>
                                </div>
                            </div>
        </div>
    `;
}

function generateAI() {
    const customPrompt = document.getElementById('custom-prompt').value.trim();
    
    console.log('üöÄ –ó–∞–ø—É—Å–∫ AI –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:', {
        campaignId: currentCampaignId,
        customPrompt: customPrompt
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    const content = document.getElementById('ai-content');
    content.innerHTML = `
        <div class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
            <p class="text-gray-600 text-lg">ü§ñ Claude –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç—ã...</p>
            <p class="text-gray-500 text-sm mt-2">–ü—Ä–æ–º–ø—Ç: "${customPrompt || '—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π'}"</p>
            <p class="text-gray-500 text-xs mt-1">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</p>
        </div>
    `;
    
    const requestData = {
        custom_prompt: customPrompt
    };
    
    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å:', requestData);
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º AI –∑–∞–¥–∞—á—É
    fetch(`/api/ai/campaigns/${currentCampaignId}/copywriting/start/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
        return response.json();
    })
    .then(data => {
        console.log('üìã –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);
        
        if (data.success) {
            console.log('‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞, ID:', data.job_id);
            
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
            setTimeout(() => {
                fetch(`/api/ai/jobs/${data.job_id}/status/`)
                .then(response => response.json())
                .then(statusData => {
                    console.log('üìä –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏:', statusData);
                    
                    if (statusData.status === 'completed') {
                        console.log('üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω:', statusData.result);
                        showResults(statusData.result);
                    } else if (statusData.status === 'failed') {
                        showError('–ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π: ' + (statusData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    } else {
                        showError('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å: ' + statusData.status);
                    }
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
                    showError('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + error.message);
                });
            }, 500);
            
        } else {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏:', data.error);
            showError('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ AI: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
        showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    });
}

function showResults(result) {
    const content = document.getElementById('ai-content');
    let html = '<div class="space-y-6">';
    
    html += '<div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">';
    html += '<h3 class="text-green-800 font-semibold mb-2">‚úÖ –¢–µ–∫—Å—Ç—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ!</h3>';
    html += '<p class="text-green-700 text-sm">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"</p>';
    html += '</div>';
    
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    if (result.headline_variants && result.headline_variants.length > 0) {
        html += '<div class="bg-white border rounded-lg p-4">';
        html += '<h4 class="font-semibold mb-3 text-gray-800">üìù –ó–∞–≥–æ–ª–æ–≤–∫–∏:</h4>';
        result.headline_variants.forEach((headline, index) => {
            html += `<label class="flex items-start space-x-3 mb-3 p-2 rounded hover:bg-gray-50 cursor-pointer">
                <input type="radio" name="headline" value="${escapeHtml(headline)}" class="mt-1 text-purple-600">
                <span class="text-sm flex-1 leading-relaxed">${escapeHtml(headline)}</span>
            </label>`;
        });
        html += '</div>';
    }
    
    // CTA –∫–Ω–æ–ø–∫–∏
    if (result.cta_variants && result.cta_variants.length > 0) {
        html += '<div class="bg-white border rounded-lg p-4">';
        html += '<h4 class="font-semibold mb-3 text-gray-800">üî• –ü—Ä–∏–∑—ã–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é:</h4>';
        result.cta_variants.forEach((cta, index) => {
            html += `<label class="flex items-center space-x-3 mb-3 p-2 rounded hover:bg-gray-50 cursor-pointer">
                <input type="radio" name="cta" value="${escapeHtml(cta)}" class="text-purple-600">
                <span class="text-sm font-medium">${escapeHtml(cta)}</span>
            </label>`;
        });
        html += '</div>';
    }
    
    // –û–ø–∏—Å–∞–Ω–∏–µ
    if (result.description) {
        html += '<div class="bg-green-50 border border-green-200 rounded-lg p-4">';
        html += '<h4 class="font-semibold mb-3 text-green-800">üìÑ –û–ø–∏—Å–∞–Ω–∏–µ:</h4>';
        html += `<label class="flex items-start space-x-3 p-2 rounded hover:bg-green-100 cursor-pointer">
            <input type="checkbox" name="description" value="${escapeHtml(result.description)}" class="mt-1 text-green-600">
            <span class="text-sm flex-1 leading-relaxed">${escapeHtml(result.description)}</span>
        </label>`;
        html += '</div>';
    }
    
    // SEO
    if (result.seo) {
        html += '<div class="bg-blue-50 border border-blue-200 rounded-lg p-4">';
        html += '<h4 class="font-semibold mb-3 text-blue-800">üîç SEO —Ç–µ–≥–∏:</h4>';
        html += `<div class="space-y-3">`;
        
        html += `<label class="flex items-start space-x-3 p-2 rounded hover:bg-blue-100 cursor-pointer">
            <input type="checkbox" name="seo_title" value="${escapeHtml(result.seo.title || '')}" class="mt-1 text-blue-600">
            <div class="flex-1">
                <div class="text-sm font-medium text-blue-700">SEO Title:</div>
                <div class="text-sm text-gray-700">${escapeHtml(result.seo.title || '')}</div>
            </div>
        </label>`;
        
        html += `<label class="flex items-start space-x-3 p-2 rounded hover:bg-blue-100 cursor-pointer">
            <input type="checkbox" name="seo_description" value="${escapeHtml(result.seo.desc || '')}" class="mt-1 text-blue-600">
            <div class="flex-1">
                <div class="text-sm font-medium text-blue-700">SEO Description:</div>
                <div class="text-sm text-gray-700">${escapeHtml(result.seo.desc || '')}</div>
            </div>
        </label>`;
        
        html += `</div></div>`;
    }
    
    html += `
        <div class="flex space-x-3 pt-6 border-t">
            <button onclick="applyCopywriting()" class="flex-1 px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors">
                ‚ú® –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
            </button>
            <button onclick="showPromptForm()" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition-colors">
                üîÑ –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
            </button>
            <button onclick="closeAIModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>`;
    
    content.innerHTML = html;
}

function applyCopywriting() {
    const selectedHeadline = document.querySelector('input[name="headline"]:checked')?.value;
    const selectedCTA = document.querySelector('input[name="cta"]:checked')?.value;
    const selectedDescription = document.querySelector('input[name="description"]:checked')?.value;
    const selectedSeoTitle = document.querySelector('input[name="seo_title"]:checked')?.value;
    const selectedSeoDescription = document.querySelector('input[name="seo_description"]:checked')?.value;
    
    if (!selectedHeadline && !selectedCTA && !selectedDescription && !selectedSeoTitle && !selectedSeoDescription) {
        alert('‚ùó –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è');
        return;
    }
    
    const data = {};
    if (selectedHeadline) data.headline = selectedHeadline;
    if (selectedCTA) data.cta_text = selectedCTA;
    if (selectedDescription) data.description = selectedDescription;
    if (selectedSeoTitle) data.seo_title = selectedSeoTitle;
    if (selectedSeoDescription) data.seo_description = selectedSeoDescription;
    
    console.log('üì§ –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ:', {
        headline: selectedHeadline ? '–≤—ã–±—Ä–∞–Ω' : '–Ω–µ –≤—ã–±—Ä–∞–Ω',
        cta_text: selectedCTA ? '–≤—ã–±—Ä–∞–Ω' : '–Ω–µ –≤—ã–±—Ä–∞–Ω',
        description: selectedDescription ? '–≤—ã–±—Ä–∞–Ω' : '–Ω–µ –≤—ã–±—Ä–∞–Ω',
        seo_title: selectedSeoTitle ? '–≤—ã–±—Ä–∞–Ω' : '–Ω–µ –≤—ã–±—Ä–∞–Ω',
        seo_description: selectedSeoDescription ? '–≤—ã–±—Ä–∞–Ω' : '–Ω–µ –≤—ã–±—Ä–∞–Ω'
    });
    console.log('üìã –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:', data);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–º, —á—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
    const applyingItems = [];
    if (selectedHeadline) applyingItems.push('–∑–∞–≥–æ–ª–æ–≤–æ–∫');
    if (selectedCTA) applyingItems.push('CTA –∫–Ω–æ–ø–∫—É');
    if (selectedDescription) applyingItems.push('–æ–ø–∏—Å–∞–Ω–∏–µ');
    if (selectedSeoTitle) applyingItems.push('SEO –∑–∞–≥–æ–ª–æ–≤–æ–∫');
    if (selectedSeoDescription) applyingItems.push('SEO –æ–ø–∏—Å–∞–Ω–∏–µ');
    
    const content = document.getElementById('ai-content');
    content.innerHTML = `
        <div class="text-center py-8">
            <div class="animate-pulse text-4xl mb-4">üíæ</div>
            <p class="text-gray-600">–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã...</p>
            <p class="text-gray-500 text-sm mt-2">–ü—Ä–∏–º–µ–Ω—è–µ–º: ${applyingItems.join(', ')}</p>
        </div>
    `;
    
    fetch(`/api/ai/campaigns/${currentCampaignId}/copywriting/apply/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            content.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-6xl mb-4">üéâ</div>
                    <h3 class="text-xl font-semibold text-green-600 mb-2">–¢–µ–∫—Å—Ç—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!</h3>
                    <p class="text-gray-600 mb-4">–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</p>
                    <button onclick="window.location.reload()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    </button>
                </div>
            `;
        } else {
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    });
}

function showError(message) {
    const content = document.getElementById('ai-content');
    content.innerHTML = `
        <div class="text-center py-8">
            <div class="text-6xl mb-4">üòû</div>
            <div class="text-red-600 font-semibold mb-4">${escapeHtml(message)}</div>
            <div class="space-x-3">
                <button onclick="showPromptForm()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                    üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
                <button onclick="closeAIModal()" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    `;
}

function closeAIModal() {
    document.getElementById('ai-modal').classList.add('hidden');
    currentCampaignId = null;
}

function getCsrfToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
}

function setPrompt(promptText) {
    const textarea = document.getElementById('custom-prompt');
    if (textarea) {
        textarea.value = promptText;
        textarea.focus();
    }
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}
</script>

{% endblock %}
