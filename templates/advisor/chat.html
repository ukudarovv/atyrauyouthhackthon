{% extends 'base.html' %}

{% block title %}AI –°–æ–≤–µ—Ç—á–∏–∫{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-white shadow rounded-lg">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <span class="text-2xl mr-3">ü§ñ</span>
                    <h1 class="text-xl font-semibold text-gray-900">AI –°–æ–≤–µ—Ç—á–∏–∫</h1>
                    <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">LIVE</span>
                    <div class="ml-2 flex items-center text-xs text-gray-500">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse mr-1"></div>
                        <span id="live-status">–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å–µ–π—á–∞—Å</span>
                    </div>
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º –±–∏–∑–Ω–µ—Å–µ -->
                    <div class="ml-3 px-2 py-1 bg-gray-100 rounded text-xs">
                        <span class="text-gray-600">üè¢</span>
                        <span class="font-medium">{{ business.name }}</span>
                        <a href="{% url 'businesses:list' %}" class="ml-1 text-blue-600 hover:text-blue-800" title="–°–º–µ–Ω–∏—Ç—å –±–∏–∑–Ω–µ—Å">‚öôÔ∏è</a>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="relative">
                        <button onclick="toggleExportMenu()" class="px-2 py-1 bg-purple-100 hover:bg-purple-200 rounded text-xs transition-colors" title="–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö">
                            üìä –≠–∫—Å–ø–æ—Ä—Ç
                        </button>
                        <div id="export-menu" class="hidden absolute right-0 top-8 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-48">
                            <div class="p-2 border-b border-gray-100">
                                <div class="text-xs font-medium text-gray-700 mb-1">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
                                <div class="flex gap-1">
                                    <a href="{% url 'advisor:export_analytics' 'excel' %}" class="px-2 py-1 bg-green-100 hover:bg-green-200 rounded text-xs transition-colors">Excel</a>
                                    <a href="{% url 'advisor:export_analytics' 'pdf' %}" class="px-2 py-1 bg-red-100 hover:bg-red-200 rounded text-xs transition-colors">PDF</a>
                                    <a href="{% url 'advisor:export_analytics' 'csv' %}" class="px-2 py-1 bg-blue-100 hover:bg-blue-200 rounded text-xs transition-colors">CSV</a>
                                </div>
                            </div>
                            <div class="p-2">
                                <div class="text-xs font-medium text-gray-700 mb-1">üí¨ –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞</div>
                                <div class="flex gap-1">
                                    <button onclick="exportChat('pdf')" class="px-2 py-1 bg-red-100 hover:bg-red-200 rounded text-xs transition-colors">PDF</button>
                                    <button onclick="exportChat('txt')" class="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-xs transition-colors">TXT</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button onclick="refreshMetrics()" class="px-2 py-1 bg-green-100 hover:bg-green-200 rounded text-xs transition-colors" title="–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏">
                        üîÑ
                    </button>
                    <div class="flex gap-1">
                        <button onclick="clearMessagesOnly()" class="px-2 py-1 bg-yellow-100 hover:bg-yellow-200 rounded text-xs transition-colors" title="–û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª—å–Ω–æ">
                            üßπ
                        </button>
                        <button onclick="newSession()" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm transition-colors" title="–ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è">
                            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>



        <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
        <div id="messages-container" class="px-6 py-4 max-h-96 overflow-y-auto">
            {% include 'advisor/_messages.html' %}
        </div>





        <!-- –ë—ã—Å—Ç—Ä—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ -->
        <div class="px-6 py-3 bg-gray-50 border-t border-gray-200">
            <div class="space-y-2 mb-3">
                <div class="text-xs text-gray-500">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –º–µ—Ç—Ä–∏–∫–∏</div>
                <div class="flex flex-wrap gap-2">
                    <button type="button" class="px-2 py-1 bg-blue-100 hover:bg-blue-200 rounded text-sm transition-colors"
                            onclick="const i=document.querySelector('input[name=q]'); i.value='–°–∫–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤?'; i.form.requestSubmit();">
                        –°–∫–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤?
                    </button>
                    <button type="button" class="px-2 py-1 bg-blue-100 hover:bg-blue-200 rounded text-sm transition-colors"
                            onclick="const i=document.querySelector('input[name=q]'); i.value='–°–∫–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è –≤—ã–¥–∞–Ω–æ –∫—É–ø–æ–Ω–æ–≤?'; i.form.requestSubmit();">
                        –°–∫–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è –≤—ã–¥–∞–Ω–æ –∫—É–ø–æ–Ω–æ–≤?
                    </button>
                    <button type="button" class="px-2 py-1 bg-blue-100 hover:bg-blue-200 rounded text-sm transition-colors"
                            onclick="const i=document.querySelector('input[name=q]'); i.value='–°–∫–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è –ø–æ–≥–∞—à–µ–Ω–∏–π?'; i.form.requestSubmit();">
                        –°–∫–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è –ø–æ–≥–∞—à–µ–Ω–∏–π?
                    </button>
                    <button type="button" class="px-2 py-1 bg-blue-100 hover:bg-blue-200 rounded text-sm transition-colors"
                            onclick="const i=document.querySelector('input[name=q]'); i.value='CR issue‚Üíredeem —Å–µ–≥–æ–¥–Ω—è?'; i.form.requestSubmit();">
                        CR issue‚Üíredeem —Å–µ–≥–æ–¥–Ω—è?
                    </button>
                    <button type="button" class="px-2 py-1 bg-blue-100 hover:bg-blue-200 rounded text-sm transition-colors"
                            onclick="const i=document.querySelector('input[name=q]'); i.value='–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ —Å–µ–≥–æ–¥–Ω—è?'; i.form.requestSubmit();">
                        –°—Ä–µ–¥–Ω–∏–π —á–µ–∫ —Å–µ–≥–æ–¥–Ω—è?
                    </button>
                </div>

                <div class="text-xs text-gray-500 mt-2">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞/—Ç—Ä–µ–Ω–¥—ã</div>
                <div class="flex flex-wrap gap-2">
                    <button type="button" class="px-2 py-1 bg-green-100 hover:bg-green-200 rounded text-sm transition-colors"
                            onclick="const i=document.querySelector('input[name=q]'); i.value='–¢—Ä–µ–Ω–¥ –ø–æ–≥–∞—à–µ–Ω–∏–π –∑–∞ 30 –¥–Ω–µ–π'; i.form.requestSubmit();">
                        –¢—Ä–µ–Ω–¥ –ø–æ–≥–∞—à–µ–Ω–∏–π –∑–∞ 30 –¥–Ω–µ–π
                    </button>
                    <button type="button" class="px-2 py-1 bg-green-100 hover:bg-green-200 rounded text-sm transition-colors"
                            onclick="const i=document.querySelector('input[name=q]'); i.value='–¢–æ–ø –∫–∞–º–ø–∞–Ω–∏–π –ø–æ –ø–æ–≥–∞—à–µ–Ω–∏—è–º'; i.form.requestSubmit();">
                        –¢–æ–ø –∫–∞–º–ø–∞–Ω–∏–π –ø–æ –ø–æ–≥–∞—à–µ–Ω–∏—è–º
                    </button>
                    <button type="button" class="px-2 py-1 bg-green-100 hover:bg-green-200 rounded text-sm transition-colors"
                            onclick="const i=document.querySelector('input[name=q]'); i.value='–í–∫–ª–∞–¥ –∫–∞–Ω–∞–ª–æ–≤ –∑–∞ 30 –¥–Ω–µ–π'; i.form.requestSubmit();">
                        –í–∫–ª–∞–¥ –∫–∞–Ω–∞–ª–æ–≤ –∑–∞ 30 –¥–Ω–µ–π
                    </button>
                    <button type="button" class="px-2 py-1 bg-green-100 hover:bg-green-200 rounded text-sm transition-colors"
                            onclick="const i=document.querySelector('input[name=q]'); i.value='–ù–µ–¥–µ–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–¥'; i.form.requestSubmit();">
                        –ù–µ–¥–µ–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–¥
                    </button>
                </div>

                <div class="text-xs text-gray-500 mt-2">üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏/–¥–µ–π—Å—Ç–≤–∏—è</div>
                <div class="flex flex-wrap gap-2">
                    <button type="button" class="px-2 py-1 bg-yellow-100 hover:bg-yellow-200 rounded text-sm transition-colors"
                            onclick="const i=document.querySelector('input[name=q]'); i.value='–°–¥–µ–ª–∞–π —á–µ—Ä–Ω–æ–≤–∏–∫ —Ä–∞—Å—Å—ã–ª–∫–∏ –ø–æ VIP –Ω–∞ –∑–∞–≤—Ç—Ä–∞ 10:00'; i.form.requestSubmit();">
                        –°–¥–µ–ª–∞–π —á–µ—Ä–Ω–æ–≤–∏–∫ —Ä–∞—Å—Å—ã–ª–∫–∏ –ø–æ VIP –Ω–∞ –∑–∞–≤—Ç—Ä–∞ 10:00
                    </button>
                    <button type="button" class="px-2 py-1 bg-yellow-100 hover:bg-yellow-200 rounded text-sm transition-colors"
                            onclick="const i=document.querySelector('input[name=q]'); i.value='–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π –∫–∞—Å–∫–∞–¥ –ø–æ–¥ –±—é–¥–∂–µ—Ç 50000'; i.form.requestSubmit();">
                        –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π –∫–∞—Å–∫–∞–¥ –ø–æ–¥ –±—é–¥–∂–µ—Ç 50000
                    </button>
                    <button type="button" class="px-2 py-1 bg-yellow-100 hover:bg-yellow-200 rounded text-sm transition-colors"
                            onclick="const i=document.querySelector('input[name=q]'); i.value='–ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–∞—à–µ–Ω–∏–π –Ω–∞ 7 –¥–Ω–µ–π'; i.form.requestSubmit();">
                        –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–∞—à–µ–Ω–∏–π –Ω–∞ 7 –¥–Ω–µ–π
                    </button>
                    <button type="button" class="px-2 py-1 bg-yellow-100 hover:bg-yellow-200 rounded text-sm transition-colors"
                            onclick="const i=document.querySelector('input[name=q]'); i.value='–°–æ–∑–¥–∞–π Wallet-–æ—Ñ—Ñ–µ—Ä ‚àí15% –¥–æ –∑–∞–≤—Ç—Ä–∞'; i.form.requestSubmit();">
                        –°–æ–∑–¥–∞–π Wallet-–æ—Ñ—Ñ–µ—Ä ‚àí15% –¥–æ –∑–∞–≤—Ç—Ä–∞
                    </button>
                </div>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ -->
        <div class="px-6 py-4 border-t border-gray-200">
            <form method="post" class="flex gap-2" onsubmit="return handleSubmit(this)" id="chat-form">
                {% csrf_token %}
                <div class="flex-1 relative">
                    <input type="text" name="q" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ üé§ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞..." 
                           class="w-full px-3 py-2 pr-12 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           autocomplete="off" required id="message-input">
                    <button type="button" id="voice-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 p-1 text-gray-500 hover:text-blue-600 transition-colors">
                        üé§
                    </button>
                </div>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" id="submit-btn">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </form>
        </div>
    </div>
</div>

<script>
// Django URLs –∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è JavaScript
const URLS = {
    newSession: '{% url "advisor:new_session" %}',
    exportChat: '{% url "advisor:export_chat" 0 "pdf" %}'
};

const SESSION_ID = '{{ session.id|default:"" }}';

// –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
console.log('JavaScript loading...');
console.log('URLs:', URLS);
console.log('Session ID:', SESSION_ID);

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤
function initializeCharts() {
    console.log('Initializing charts...');
    
    const canvases = document.querySelectorAll('.chart-canvas');
    console.log('Found canvases:', canvases.length);
    
    canvases.forEach((canvas, index) => {
        try {
            console.log(`Processing canvas ${index + 1}:`, canvas);
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤
            const chartType = canvas.getAttribute('data-chart-type');
            const labelsStr = canvas.getAttribute('data-chart-labels');
            const dataStr = canvas.getAttribute('data-chart-data');
            const title = canvas.getAttribute('data-chart-title');
            const backgroundColor = canvas.getAttribute('data-chart-bg');
            const borderColor = canvas.getAttribute('data-chart-border');
            
            console.log('Raw attributes:', {
                chartType,
                labelsStr,
                dataStr,
                title,
                backgroundColor,
                borderColor
            });
            
            // –ü–∞—Ä—Å–∏–º JSON –¥–∞–Ω–Ω—ã–µ
            const labels = JSON.parse(labelsStr || '[]');
            const data = JSON.parse(dataStr || '[]');
            
            console.log('Parsed data:', { chartType, labels, data, title });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Chart.js –¥–æ—Å—Ç—É–ø–µ–Ω
            if (typeof Chart === 'undefined') {
                console.error('Chart.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
            const chart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
                        data: data,
                        backgroundColor: chartType === 'line' ? 'rgba(59, 130, 246, 0.1)' : backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 2,
                        fill: chartType === 'line'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: title
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            console.log('Chart created successfully:', chart);
            
        } catch (error) {
            console.error('Error creating chart:', error);
            console.error('Canvas element:', canvas);
        }
    });
}

function handleSubmit(form) {
    const input = form.querySelector('input[name="q"]');
    const submitBtn = form.querySelector('button[type="submit"]');
    
    if (!input.value.trim()) return false;
    
    const message = input.value.trim();
    console.log('Sending message:', message);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    submitBtn.textContent = '...';
    submitBtn.disabled = true;
    
    const formData = new FormData(form);
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.text();
    })
    .then(html => {
        console.log('Received HTML:', html.substring(0, 200));
        
        // –ü—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–±–ª–∞—Å—Ç—å —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        const messagesContainer = document.getElementById('messages-container');
        messagesContainer.innerHTML = html;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è HTML
        initializeCharts();
        
        scrollToBottom();
    })
    .catch(error => {
        console.error('Error:', error);
        addAssistantMessage('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + error.message);
    })
    .finally(() => {
        submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
        submitBtn.disabled = false;
        input.value = '';
        input.focus();
    });
    
    return false;
}

function addUserMessage(text) {
    const container = document.getElementById('messages-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'mb-4 flex justify-end';
    messageDiv.innerHTML = `
        <div class="max-w-xs lg:max-w-md px-4 py-2 bg-blue-600 text-white rounded-lg">
            ${escapeHtml(text)}
        </div>
    `;
    container.appendChild(messageDiv);
    scrollToBottom();
}

function addAssistantMessage(text) {
    const container = document.getElementById('messages-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'mb-4 flex justify-start';
    messageDiv.innerHTML = `
        <div class="max-w-xs lg:max-w-md px-4 py-2 bg-gray-100 text-gray-900 rounded-lg">
            ${escapeHtml(text)}
        </div>
    `;
    container.appendChild(messageDiv);
    scrollToBottom();
}

function scrollToBottom() {
    const container = document.getElementById('messages-container');
    container.scrollTop = container.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function newSession() {
    console.log('newSession() called');
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?')) {
        try {
            // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å POST –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = URLS.newSession;
            
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            form.appendChild(csrfToken);
            document.body.appendChild(form);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
            form.submit();
            
            // –£–¥–∞–ª—è–µ–º —Ñ–æ—Ä–º—É
            document.body.removeChild(form);
        } catch (error) {
            console.error('Error creating new session:', error);
            // Fallback: –ø—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
            document.getElementById('messages-container').innerHTML = '';
            window.location.reload();
        }
    }
}

// –ë—ã—Å—Ç—Ä–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª—å–Ω–æ
function clearMessagesOnly() {
    console.log('clearMessagesOnly() called');
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª—å–Ω–æ? (–ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±–∞–∑–µ)')) {
        document.getElementById('messages-container').innerHTML = '';
        document.querySelector('input[name="q"]').focus();
        console.log('‚úÖ Messages cleared visually');
    }
}

// –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
function testButtons() {
    console.log('üß™ Testing buttons...');
    alert('–ö–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç! JavaScript –∑–∞–≥—Ä—É–∂–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.');
}

// –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Chat page loaded successfully!');
    console.log('‚úÖ Functions available:', {
        newSession: typeof newSession,
        clearMessagesOnly: typeof clearMessagesOnly,
        handleSubmit: typeof handleSubmit,
        initializeCharts: typeof initializeCharts
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏
    initializeCharts();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–Ω–æ–ø–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    const clearBtn = document.querySelector('button[onclick="newSession()"]');
    const quickClearBtn = document.querySelector('button[onclick="clearMessagesOnly()"]');
    
    console.log('üîò Buttons found:', {
        clearBtn: !!clearBtn,
        quickClearBtn: !!quickClearBtn
    });
    
    document.querySelector('input[name="q"]').focus();
    scrollToBottom();
});

// –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥
let recognition;
if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'ru-RU';
    
    const voiceBtn = document.getElementById('voice-btn');
    const messageInput = document.getElementById('message-input');
    
    voiceBtn.addEventListener('click', function() {
        if (recognition) {
            voiceBtn.textContent = 'üî¥';
            voiceBtn.classList.add('animate-pulse');
            recognition.start();
        }
    });
    
    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        messageInput.value = transcript;
        voiceBtn.textContent = 'üé§';
        voiceBtn.classList.remove('animate-pulse');
    };
    
    recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        voiceBtn.textContent = 'üé§';
        voiceBtn.classList.remove('animate-pulse');
    };
    
    recognition.onend = function() {
        voiceBtn.textContent = 'üé§';
        voiceBtn.classList.remove('animate-pulse');
    };
} else {
    document.getElementById('voice-btn').style.display = 'none';
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫
function refreshMetrics() {
    console.log('refreshMetrics() called');
    const refreshBtn = document.querySelector('button[onclick="refreshMetrics()"]');
    const statusEl = document.getElementById('live-status');
    
    refreshBtn.textContent = '‚è≥';
    statusEl.textContent = '–û–±–Ω–æ–≤–ª—è–µ–º...';
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–∞–µ–º –≤–æ–ø—Ä–æ—Å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    const input = document.querySelector('input[name="q"]');
    input.value = '–°–∫–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤?';
    
    setTimeout(() => {
        document.getElementById('chat-form').requestSubmit();
        refreshBtn.textContent = 'üîÑ';
        statusEl.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å–µ–π—á–∞—Å';
    }, 500);
}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
setInterval(() => {
    const statusEl = document.getElementById('live-status');
    const now = new Date();
    statusEl.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ –≤ ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
}, 300000); // 5 –º–∏–Ω—É—Ç

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
setInterval(() => {
    const statusEl = document.getElementById('live-status');
    if (statusEl.textContent.includes('–û–±–Ω–æ–≤–ª–µ–Ω–æ –≤')) {
        return; // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ –≤—Ä–µ–º—è
    }
    const now = new Date();
    const minutes = Math.floor((now - new Date(now.toDateString())) / 60000);
    if (minutes === 0) {
        statusEl.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å–µ–π—á–∞—Å';
    } else if (minutes < 60) {
        statusEl.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ ${minutes} –º–∏–Ω –Ω–∞–∑–∞–¥`;
    } else {
        const hours = Math.floor(minutes / 60);
        statusEl.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ ${hours}—á –Ω–∞–∑–∞–¥`;
    }
}, 60000); // 1 –º–∏–Ω—É—Ç–∞

// –§—É–Ω–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
function toggleExportMenu() {
    const menu = document.getElementById('export-menu');
    menu.classList.toggle('hidden');
}

function exportChat(format) {
    if (SESSION_ID && SESSION_ID.trim()) {
        const url = URLS.exportChat.replace('0', SESSION_ID).replace('pdf', format);
        window.open(url, '_blank');
    } else {
        alert('–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
    }
    toggleExportMenu();
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.addEventListener('click', function(event) {
    const menu = document.getElementById('export-menu');
    const button = event.target.closest('button[onclick="toggleExportMenu()"]');
    
    if (!button && !menu.contains(event.target)) {
        menu.classList.add('hidden');
    }
});


</script>
{% endblock %}

