{% extends 'base.html' %}

{% block title %}–ê–Ω—Ç–∏—Ñ—Ä–æ–¥{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-semibold">üõ°Ô∏è –ñ—É—Ä–Ω–∞–ª —Ä–∏—Å–∫–æ–≤</h1>
            <p class="text-gray-600">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-2xl font-bold text-blue-600">{{ stats.total }}</div>
            <div class="text-sm text-gray-600">–í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-2xl font-bold text-red-600">{{ stats.blocks }}</div>
            <div class="text-sm text-gray-600">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-2xl font-bold text-yellow-600">{{ stats.warns }}</div>
            <div class="text-sm text-gray-600">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-2xl font-bold text-orange-600">{{ stats.unresolved }}</div>
            <div class="text-sm text-gray-600">–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <form method="get" class="flex flex-wrap gap-4 items-end">
            <!-- –ë–∏–∑–Ω–µ—Å -->
            {% if businesses.count > 1 %}
            <div>
                <label for="business" class="block text-sm font-medium text-gray-700 mb-1">
                    –ë–∏–∑–Ω–µ—Å
                </label>
                <select name="business" id="business" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">–í—Å–µ</option>
                    {% for biz in businesses %}
                        <option value="{{ biz.id }}" {% if current_business == biz.id|stringformat:"s" %}selected{% endif %}>{{ biz.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <!-- –¢–∏–ø -->
            <div>
                <label for="kind" class="block text-sm font-medium text-gray-700 mb-1">
                    –¢–∏–ø
                </label>
                <select name="kind" id="kind" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">–í—Å–µ</option>
                    <option value="issue" {% if current_kind == 'issue' %}selected{% endif %}>–í—ã–¥–∞—á–∏</option>
                    <option value="redeem" {% if current_kind == 'redeem' %}selected{% endif %}>–ü–æ–≥–∞—à–µ–Ω–∏—è</option>
                </select>
            </div>
            
            <!-- –†–µ—à–µ–Ω–∏–µ -->
            <div>
                <label for="decision" class="block text-sm font-medium text-gray-700 mb-1">
                    –†–µ—à–µ–Ω–∏–µ
                </label>
                <select name="decision" id="decision" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">–í—Å–µ —Ä–µ—à–µ–Ω–∏—è</option>
                    <option value="allow" {% if current_decision == 'allow' %}selected{% endif %}>Allow</option>
                    <option value="warn" {% if current_decision == 'warn' %}selected{% endif %}>Warn</option>
                    <option value="block" {% if current_decision == 'block' %}selected{% endif %}>Block</option>
                </select>
            </div>
            
            <!-- –¢–µ–ª–µ—Ñ–æ–Ω -->
            <div>
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
                    –¢–µ–ª–µ—Ñ–æ–Ω
                </label>
                <input name="phone" id="phone" placeholder="7000000000" value="{{ current_phone }}" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            
            <!-- IP -->
            <div>
                <label for="ip" class="block text-sm font-medium text-gray-700 mb-1">
                    IP –∞–¥—Ä–µ—Å
                </label>
                <input name="ip" id="ip" placeholder="192.168.1.1" value="{{ current_ip }}" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            
            <!-- –°—Ç–∞—Ç—É—Å -->
            <div>
                <label for="resolved" class="block text-sm font-medium text-gray-700 mb-1">
                    –°—Ç–∞—Ç—É—Å
                </label>
                <select name="resolved" id="resolved" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">–í—Å–µ</option>
                    <option value="0" {% if current_resolved == '0' %}selected{% endif %}>–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</option>
                    <option value="1" {% if current_resolved == '1' %}selected{% endif %}>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</option>
                </select>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="flex space-x-2">
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    üîç –ù–∞–π—Ç–∏
                </button>
                <a href="{% url 'fraud:list' %}" class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50">
                    ‚úñÔ∏è –°–±—Ä–æ—Å–∏—Ç—å
                </a>
            </div>
        </form>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å–æ–±—ã—Ç–∏–π -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            –í—Ä–µ–º—è
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            –¢–∏–ø
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Score
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            –†–µ—à–µ–Ω–∏–µ
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            –¢–µ–ª–µ—Ñ–æ–Ω
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            IP
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            –ü—Ä–∏—á–∏–Ω—ã
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            –î–µ–π—Å—Ç–≤–∏—è
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for r in page_obj.object_list %}
                    <tr class="hover:bg-gray-50 {% if not r.resolved and r.decision != 'allow' %}bg-yellow-50{% endif %}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ r.created_at|date:"d.m.Y H:i" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 py-1 text-xs rounded-full {% if r.kind == 'issue' %}bg-blue-100 text-blue-800{% else %}bg-green-100 text-green-800{% endif %}">
                                {{ r.get_kind_display }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <span class="{% if r.score >= 50 %}text-red-600{% elif r.score >= 20 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                {{ r.score }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full
                                {% if r.decision == 'block' %}bg-red-100 text-red-700{% elif r.decision == 'warn' %}bg-yellow-100 text-yellow-700{% else %}bg-green-100 text-green-700{% endif %}">
                                {{ r.decision|upper }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ r.phone|default:"‚Äî" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ r.ip|default:"‚Äî" }}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">
                            <div class="max-w-xs">
                                {% for reason in r.reasons %}
                                    <span class="inline-block bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded mr-1 mb-1">{{ reason }}</span>
                                {% endfor %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex flex-col space-y-1">
                                {% if not r.resolved %}
                                    <a href="{% url 'fraud:resolve' r.id %}" 
                                       class="text-blue-600 hover:text-blue-900 hover:underline text-xs">
                                        ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ
                                    </a>
                                {% else %}
                                    <span class="text-green-600 text-xs">‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</span>
                                {% endif %}
                                
                                {% if r.ip %}
                                <form method="post" action="{% url 'fraud:denies_add' %}" class="inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="type" value="ip">
                                    <input type="hidden" name="value" value="{{ r.ip }}">
                                    <input type="hidden" name="business_id" value="{{ r.business.id }}">
                                    <button class="text-red-600 hover:text-red-900 hover:underline text-xs">
                                        üö´ –ë–ª–æ–∫ IP
                                    </button>
                                </form>
                                {% endif %}
                                
                                {% if r.phone %}
                                <form method="post" action="{% url 'fraud:denies_add' %}" class="inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="type" value="phone">
                                    <input type="hidden" name="value" value="{{ r.phone }}">
                                    <input type="hidden" name="business_id" value="{{ r.business.id }}">
                                    <button class="text-red-600 hover:text-red-900 hover:underline text-xs">
                                        üö´ –ë–ª–æ–∫ —Ç–µ–ª.
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                            <div class="text-4xl mb-4">üõ°Ô∏è</div>
                            <h3 class="text-lg font-medium mb-2">–°–æ–±—ã—Ç–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                            <p>–°–æ–±—ã—Ç–∏—è –∞–Ω—Ç–∏—Ñ—Ä–æ–¥–∞ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        {% if page_obj.has_other_pages %}
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                    </a>
                {% endif %}
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        –°–ª–µ–¥—É—é—â–∞—è
                    </a>
                {% endif %}
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        –ü–æ–∫–∞–∑–∞–Ω–æ
                        <span class="font-medium">{{ page_obj.start_index }}</span>
                        -
                        <span class="font-medium">{{ page_obj.end_index }}</span>
                        –∏–∑
                        <span class="font-medium">{{ page_obj.paginator.count }}</span>
                        —Å–æ–±—ã—Ç–∏–π
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        {% if page_obj.has_previous %}
                            <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                ‚Üê
                            </a>
                        {% endif %}
                        
                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-50 text-sm font-medium text-blue-600">
                            {{ page_obj.number }}
                        </span>
                        
                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                ‚Üí
                            </a>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
